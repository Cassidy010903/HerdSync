@page "/program-run"
@using BLL.Services
@using HerdSync.Shared.DTO.Program
@inject IProgramTemplateService ProgramTemplateService
@inject IProgramRunService ProgramRunService
@inject NavigationManager Navigation

<MudSelect @bind-Value="_selectedTemplateCode" Label="Select Program Template">
    @foreach (var t in _templates)
    {
        <MudSelectItem Value="@t.ProgramTemplateCode">@t.ProgramTemplateCode</MudSelectItem>
    }
</MudSelect>

<MudButton Disabled="@(string.IsNullOrEmpty(_selectedTemplateCode))"
           OnClick="Start">Start Run</MudButton>

@code {
    private List<ProgramTemplateDTO> _templates = new();
    private string? _selectedTemplateCode;

    protected override async Task OnInitializedAsync()
    {
        _templates = (await ProgramTemplateService.GetAllAsync()).ToList();
    }

    private async Task Start()
    {
        if (string.IsNullOrEmpty(_selectedTemplateCode)) return;

        var newRun = new ProgramRunDTO
        {
            ProgramTemplateCode = _selectedTemplateCode,
            RunDate = DateTime.UtcNow,
        };

        await ProgramRunService.CreateAsync(newRun);
        Navigation.NavigateTo("/existingprograms");
    }
}