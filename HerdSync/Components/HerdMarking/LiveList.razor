@page "/livelist"
@using BLL.Services
@using HerdSync.Shared.DTO.Animal
@using HerdSync.Shared.DTO.Program
@using Microsoft.AspNetCore.Components.Web
@implements IDisposable
@inject IProgramRunAnimalService ProgramRunAnimalService
@inject IAnimalService AnimalService
@inject NavigationManager Nav

<h4>Active Program - Live List</h4>

<input @ref="scannerInput"
       @onkeydown="HandleKeyDown"
       style="position:fixed; left:-10000px; top:-10000px;"
       autocomplete="off" />

<div class="card">
    <div class="card-header align-items-center">
        <h5 class="mb-0">Scanned Animals (@animalActions.Count)</h5>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead class="small text-uppercase bg-body text-muted">
                <tr>
                    <th>Tag (RFID)</th>
                    <th>Animal</th>
                    <th>Scanned</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var action in animalActions)
                {
                    <tr>
                        <td>@(action.Animal?.AnimalTag?.RFIDTagCode ?? "-")</td>
                        <td>@(action.Animal?.DisplayIdentifier ?? action.AnimalId.ToString())</td>
                        <td>@action.CreatedDate.ToString("HH:mm:ss")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-warning mt-2">@_errorMessage</div>
}

@code {
    private ElementReference scannerInput;
    private string _scanBuffer = "";
    private DateTime _lastKey = DateTime.MinValue;
    private string? _errorMessage;
    private List<ProgramRunAnimalDTO> animalActions = new();
    private List<AnimalDTO> _allAnimals = new();

    protected override async Task OnInitializedAsync()
    {
        _allAnimals = await AnimalService.GetAllAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await scannerInput.FocusAsync();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if ((DateTime.Now - _lastKey).TotalMilliseconds > 60)
            _scanBuffer = "";

        _lastKey = DateTime.Now;

        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_scanBuffer))
                _ = AddScanAsync(_scanBuffer.Trim());
            _scanBuffer = "";
            return;
        }

        if (e.Key.Length == 1)
            _scanBuffer += e.Key;
    }

    private async Task AddScanAsync(string rfidCode)
    {
        _errorMessage = null;

        var animal = _allAnimals.FirstOrDefault(a =>
            a.AnimalTag?.RFIDTagCode == rfidCode);

        if (animal == null)
        {
            _errorMessage = $"No animal found for tag: {rfidCode}";
            await InvokeAsync(StateHasChanged);
            return;
        }

        var newEntry = new ProgramRunAnimalDTO
        {
            AnimalId = animal.AnimalId,
            Animal = animal,
            CreatedDate = DateTime.UtcNow,
            WasHandled = false,
        };

        try
        {
            var saved = await ProgramRunAnimalService.CreateAsync(newEntry);
            saved.Animal = animal;
            animalActions.Insert(0, saved);
        }
        catch
        {
            animalActions.Insert(0, newEntry);
        }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose() { }
}