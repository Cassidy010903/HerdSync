@page "/livelist"
@using BLL.Services
@using HerdSync.Shared.DTO.Animal
@using HerdSync.Shared.DTO.Program
@using Microsoft.AspNetCore.Components.Web
@implements IDisposable
@inject IProgramRunAnimalService ProgramRunAnimalService
@inject IAnimalService AnimalService
@inject NavigationManager Nav

<input @ref="scannerInput"
       @onkeydown="HandleKeyDown"
       style="position:fixed; left:-10000px; top:-10000px;"
       autocomplete="off" />

<div class="livelist-layout">
    <div class="livelist-main">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between py-3">
                <div>
                    <h5 class="mb-0">Live Scan Feed</h5>
                    <small class="text-muted">@animalActions.Count animals scanned</small>
                </div>
                <span class="badge bg-success scanning-pulse fs-6">● SCANNING</span>
            </div>

            @if (_showManualAdd)
            {
                <div class="manual-add-banner mx-3 mt-2">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bx bx-error text-warning fs-5"></i>
                        <span><strong>Tag not found.</strong> Manually select the animal to add it to the list.</span>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bx bx-search"></i></span>
                        <input type="text"
       class="form-control"
       placeholder="Search by animal number..."
       value="@_manualSearch"
       @oninput="OnManualSearchInput" />
                        <button class="btn btn-success btn-sm" @onclick="AddManual">Add</button>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="DismissManual">Cancel</button>
                    </div>
                    @if (_manualSuggestions.Any())
                    {
                        <div class="suggestions-dropdown mt-1">
                            @foreach (var animal in _manualSuggestions)
                            {
                                <div class="suggestion-item" @onclick="() => SelectManualAnimal(animal)">
                                    <strong>#@animal.DisplayIdentifier</strong>
                                    @if (animal.BirthYear.HasValue)
                                    {
                                        <span class="text-muted ms-1">— @animal.BirthYear</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <div class="table-responsive mt-2">
                <table class="table table-hover mb-0">
                    <thead class="small text-uppercase bg-light text-muted">
                        <tr>
                            <th></th>
                            <th>Animal</th>
                            <th>Gender</th>
                            <th>Age Group</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var action in animalActions.Where(a => _pinnedIds.Contains(a.AnimalId)))
                        {
                            <tr class="pinned-row">
                                <td><i class="bx bxs-pin text-warning"></i></td>
                                <td><strong>#@(action.Animal?.DisplayIdentifier ?? action.AnimalId.ToString())</strong></td>
                                <td>@(action.Animal?.Gender ?? "-")</td>
                                <td><span class="badge bg-secondary">@GetAgeGroup(action.Animal?.BirthYear)</span></td>
                                <td>
                                    <select class="form-select form-select-sm status-select"
                                            @onchange="e => SetStatus(action.AnimalId, e.Value?.ToString())">
                                        <option value="keep" selected="@(_statusMap.GetValueOrDefault(action.AnimalId) == "keep")">Keep</option>
                                        <option value="sell" selected="@(_statusMap.GetValueOrDefault(action.AnimalId) == "sell")">Sell</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" @onclick="() => TogglePin(action.AnimalId)">
                                        <i class="bx bx-pin"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        @foreach (var action in animalActions.Where(a => !_pinnedIds.Contains(a.AnimalId)))
                        {
                            var ageGroup = GetAgeGroup(action.Animal?.BirthYear);
                            var badgeColor = ageGroup switch {
                                "Calf" => "warning text-dark",
                                "Yearling" => "info text-dark",
                                _ => "secondary"
                            };
                            <tr>
                                <td></td>
                                <td>#@(action.Animal?.DisplayIdentifier ?? action.AnimalId.ToString())</td>
                                <td>@(action.Animal?.Gender ?? "-")</td>
                                <td><span class="badge bg-@badgeColor">@ageGroup</span></td>
                                <td>
                                    <select class="form-select form-select-sm status-select"
                                            @onchange="e => SetStatus(action.AnimalId, e.Value?.ToString())">
                                        <option value="keep" selected="@(_statusMap.GetValueOrDefault(action.AnimalId) == "keep")">Keep</option>
                                        <option value="sell" selected="@(_statusMap.GetValueOrDefault(action.AnimalId) == "sell")">Sell</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => TogglePin(action.AnimalId)">
                                        <i class="bx bx-pin"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="livelist-sidebar">

        <div class="card mb-3">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bx bx-bar-chart me-1"></i>Session Summary</h6>
            </div>
            <div class="card-body py-2 px-3">
                <div class="stat-row">
                    <span class="text-muted small">Total Scanned</span>
                    <strong>@animalActions.Count</strong>
                </div>
                <hr class="my-2"/>
                <div class="stat-row">
                    <span class="text-muted small">♂ Male</span>
                    <strong>@animalActions.Count(a => a.Animal?.Gender == "M")</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted small">♀ Female</span>
                    <strong>@animalActions.Count(a => a.Animal?.Gender == "F")</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted small">Unknown</span>
                    <strong>@animalActions.Count(a => a.Animal?.Gender != "M" && a.Animal?.Gender != "F")</strong>
                </div>
                <hr class="my-2"/>
                <div class="stat-row">
                    <span class="text-muted small">Calf (0-1yr)</span>
                    <strong>@animalActions.Count(a => GetAgeGroup(a.Animal?.BirthYear) == "Calf")</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted small">Yearling (1-2yr)</span>
                    <strong>@animalActions.Count(a => GetAgeGroup(a.Animal?.BirthYear) == "Yearling")</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted small">Adult (2+yr)</span>
                    <strong>@animalActions.Count(a => GetAgeGroup(a.Animal?.BirthYear) == "Adult")</strong>
                </div>
                <hr class="my-2"/>
                <div class="stat-row text-success">
                    <span class="small fw-semibold">✓ Keep</span>
                    <strong>@_statusMap.Count(s => s.Value == "keep")</strong>
                </div>
                <div class="stat-row text-danger">
                    <span class="small fw-semibold">$ Sell</span>
                    <strong>@_statusMap.Count(s => s.Value == "sell")</strong>
                </div>
                <div class="stat-row text-warning">
                    <span class="small fw-semibold"><i class="bx bxs-pin"></i> Pinned</span>
                    <strong>@_pinnedIds.Count</strong>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center"
                 style="cursor:pointer" @onclick="ToggleDosage">
                <h6 class="mb-0"><i class="bx bx-plus-medical me-1"></i>Dosage Guide</h6>
                <i class="bx @(_dosageOpen ? "bx-chevron-up" : "bx-chevron-down")"></i>
            </div>
            @if (_dosageOpen)
            {
                <div class="px-3 pt-2 pb-1">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bx bx-search"></i></span>
                        <input type="text"
                               class="form-control"
                               placeholder="Search product..."
                               @bind="_dosageSearch"
                               @bind:event="oninput" />
                    </div>
                </div>
                <div class="card-body py-2 px-3">
                    @foreach (var vaccine in _vaccines.Where(v =>
                        string.IsNullOrEmpty(_dosageSearch) ||
                        v.Name.Contains(_dosageSearch, StringComparison.OrdinalIgnoreCase)))
                    {
                        <div class="dosage-item mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <strong>@vaccine.Name</strong>
                                <span class="badge bg-primary ms-1">@vaccine.Dose</span>
                            </div>
                            <div class="text-muted" style="font-size:11px">@vaccine.Notes</div>
                        </div>
                        <hr class="my-1"/>
                    }
                </div>
            }
        </div>

    </div>
</div>

<style>
    .livelist-layout {
        display: flex;
        gap: 16px;
        height: calc(100vh - 100px);
    }

    .livelist-main { flex: 1 1 70%; overflow: auto; }
    .livelist-sidebar { flex: 0 0 280px; overflow-y: auto; }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
    }

    .status-select { width: 80px; padding: 1px 4px; font-size: 12px; }
    .pinned-row { background: #fff8e1 !important; }

    .manual-add-banner {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 13px;
    }

    .suggestions-dropdown {
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 120px;
        overflow-y: auto;
        background: #fff;
    }

    .suggestion-item {
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
    }

    .suggestion-item:hover { background: #f0f4f8; }

    .dosage-item strong { color: #2d3748; font-size: 13px; }

    .scanning-pulse { animation: pulse 2s infinite; }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    @@media (max-width: 992px) {
        .livelist-layout { flex-direction: column; height: auto; }
        .livelist-sidebar { flex: unset; width: 100%; }
    }
</style>

@code {
    private ElementReference scannerInput;
    private string _scanBuffer = "";
    private DateTime _lastKey = DateTime.MinValue;

    private bool _showManualAdd = false;
    private string _manualSearch = "";
    private AnimalDTO? _selectedManualAnimal;
    private List<AnimalDTO> _manualSuggestions = new();

    private bool _dosageOpen = true;
    private string _dosageSearch = "";

    private List<ProgramRunAnimalDTO> animalActions = new();
    private List<AnimalDTO> _allAnimals = new();
    private HashSet<Guid> _pinnedIds = new();
    private Dictionary<Guid, string> _statusMap = new();

    private List<VaccineDosage> _vaccines = new()
    {
        new() { Name = "Roundworm (Dectomax)", Dose = "1ml/50kg", Notes = "Subcutaneous injection, max 7.5ml per site" },
        new() { Name = "Lumpy Skin (Neethling)", Dose = "1 dose", Notes = "Reconstitute with 25ml diluent, SC injection" },
        new() { Name = "Brucellosis (RB51)", Dose = "2ml", Notes = "Females only, 4-8 months old" },
        new() { Name = "Blackleg (Covexin 8)", Dose = "5ml", Notes = "Deep SC, repeat in 4 weeks for first dose" },
        new() { Name = "Multivitamin (Multimin)", Dose = "1ml/100kg", Notes = "IV or SC, do not exceed 10ml" },
    };

    protected override async Task OnInitializedAsync()
{
    _allAnimals = await AnimalService.GetAllAsync();

    // Test data
    var testAnimals = new List<(string id, string gender, int birthYear)>
    {
        ("A-0042", "F", 2020),
        ("B-0117", "M", 2022),
        ("C-0088", "F", 2019),
        ("A-0201", "F", 2023),
        ("B-0055", "M", 2018),
    };

    foreach (var (id, gender, birthYear) in testAnimals)
    {
        var fakeAnimal = new AnimalDTO
        {
            AnimalId = Guid.NewGuid(),
            DisplayIdentifier = id,
            Gender = gender,
            BirthYear = birthYear,
        };
        animalActions.Add(new ProgramRunAnimalDTO
        {
            AnimalId = fakeAnimal.AnimalId,
            Animal = fakeAnimal,
            CreatedDate = DateTime.UtcNow,
            WasHandled = false,
        });
    }

    // Pin the first one to show pinned styling
    _pinnedIds.Add(animalActions[0].AnimalId);
    _statusMap[animalActions[1].AnimalId] = "sell";
    _statusMap[animalActions[3].AnimalId] = "sell";
}

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await scannerInput.FocusAsync();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if ((DateTime.Now - _lastKey).TotalMilliseconds > 60)
            _scanBuffer = "";
        _lastKey = DateTime.Now;
        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_scanBuffer))
                _ = AddScanAsync(_scanBuffer.Trim());
            _scanBuffer = "";
            return;
        }
        if (e.Key.Length == 1)
            _scanBuffer += e.Key;
    }

    private async Task AddScanAsync(string rfidCode)
    {
        var animal = _allAnimals.FirstOrDefault(a => a.AnimalTag?.RFIDTagCode == rfidCode);
        if (animal == null)
        {
            _showManualAdd = true;
            await InvokeAsync(StateHasChanged);
            return;
        }
        await AddAnimalToList(animal);
    }

    private void OnManualSearchInput(ChangeEventArgs e)
{
    _manualSearch = e.Value?.ToString() ?? "";
    _manualSuggestions = string.IsNullOrWhiteSpace(_manualSearch)
        ? new()
        : _allAnimals
            .Where(a => a.DisplayIdentifier?.Contains(_manualSearch, StringComparison.OrdinalIgnoreCase) == true)
            .Take(5)
            .ToList();
}

    private void SelectManualAnimal(AnimalDTO animal)
    {
        _selectedManualAnimal = animal;
        _manualSearch = $"#{animal.DisplayIdentifier}";
        _manualSuggestions = new();
    }

    private async Task AddManual()
    {
        if (_selectedManualAnimal != null)
            await AddAnimalToList(_selectedManualAnimal);
        DismissManual();
    }

    private void DismissManual()
    {
        _showManualAdd = false;
        _manualSearch = "";
        _selectedManualAnimal = null;
        _manualSuggestions = new();
    }

    private async Task AddAnimalToList(AnimalDTO animal)
    {
        var newEntry = new ProgramRunAnimalDTO
        {
            AnimalId = animal.AnimalId,
            Animal = animal,
            CreatedDate = DateTime.UtcNow,
            WasHandled = false,
        };
        try
        {
            var saved = await ProgramRunAnimalService.CreateAsync(newEntry);
            saved.Animal = animal;
            animalActions.Insert(0, saved);
        }
        catch
        {
            animalActions.Insert(0, newEntry);
        }
        await InvokeAsync(StateHasChanged);
    }

    private void TogglePin(Guid animalId)
    {
        if (_pinnedIds.Contains(animalId)) _pinnedIds.Remove(animalId);
        else _pinnedIds.Add(animalId);
    }

    private void SetStatus(Guid animalId, string? status)
    {
        if (status != null) _statusMap[animalId] = status;
    }

    private void ToggleDosage() => _dosageOpen = !_dosageOpen;

    private string GetAgeGroup(int? birthYear)
    {
        if (birthYear == null) return "Unknown";
        return (DateTime.Today.Year - birthYear.Value) switch
        {
            <= 1 => "Calf",
            <= 2 => "Yearling",
            _ => "Adult"
        };
    }

    public class VaccineDosage
    {
        public string Name { get; set; } = "";
        public string Dose { get; set; } = "";
        public string Notes { get; set; } = "";
    }

    public void Dispose() { }
}