@page "/existingprograms"
@using DAL.Models
@using BLL.Services

<PageTitle>Existing Programs</PageTitle>

<div class="pa-4">
    <MudText Typo="Typo.h4">Existing Programs</MudText>
    <MudText Typo="Typo.caption">Previously saved treatment programs</MudText>
</div>

<div class="container mt-5 pt-4">
    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (programs.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No programs found. Create a new program first.</MudAlert>
        <MudButton Href="/newprogram" Color="Color.Primary" Variant="MudBlazor.Variant.Filled" Class="mt-3">
            Create New Program
        </MudButton>
    }
    else
    {
        <div class="row">
            @foreach (var program in programs)
            {
                <div class="col-lg-4 col-md-6 col-12 mt-4 pt-2">
                    <div class="card border-0 bg-light rounded shadow">
                        <div class="card-body p-4">
                            <span class="badge rounded-pill bg-primary float-md-end mb-3 mb-sm-0">@program.Repeat</span>
                            <h5>@program.ProgramName</h5>
                            <div class="mt-3">
                                <span class="text-muted d-block">@program.Instructions.Count instruction(s)</span>
                                @if (program.LastRunUtc.HasValue)
                                {
                                    <span class="text-muted d-block">Last run: @program.LastRunUtc.Value.ToLocalTime().ToString("g")</span>
                                }
                            </div>

                            <div class="mt-3">
                                <MudButton OnClick="() => StartProgram(program.Id)"
                                           Color="Color.Success"
                                           Variant="MudBlazor.Variant.Filled"
                                           Disabled="@(SessionService.Current != null)">
                                    Start Program
                                </MudButton>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>


@if (SessionService.Current != null)
{
    <MudAlert Severity="Severity.Warning" Class="mt-4">
        There is already an active session running. Please end it before starting a new program.
        <MudButton Href="/livelist" Color="Color.Primary" Size="Size.Small" Class="ml-2">
            Go to Active Session
        </MudButton>
    </MudAlert>
}
